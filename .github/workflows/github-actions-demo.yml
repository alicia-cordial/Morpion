name: Deploy Astro site to Pages

on:
  push:
    branches: ["main"]

  workflow_dispatch:
    
permissions:
  contents: read
  pages: write
  id-token: write
  
concurrency:
  group: "pages"
  cancel-in-progress: false

env:
  BUILD_PATH: "." 

jobs:
  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    name: Deploy
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
  
  notify_pull_request_google_chat:
    needs: [deploy]
    runs-on: ubuntu-latest
    steps:
      - name: Notify Google Chat
        if: ${{ always() }} # Utilisez 'always' pour vous assurer que la notification est envoy√©e m√™me en cas d'√©chec des √©tapes pr√©c√©dentes
        uses: SimonScholz/google-chat-action@main
        with:
          webhookUrl: ${{ secrets.GOOGLE_CHAT_WEBHOOK_URL }}
          title: ${{ needs.deploy.result == 'success' && 'D√©ploiement r√©ussi sur Thotify ! üöÄ' || '√âchec du d√©ploiement sur Thotify ‚ùå' }}
          subtitle: ${{ needs.deploy.result =='success' && 'Les modifications ont √©t√© fusionn√©es avec succ√®s ! üòª' || 'Il y √† eu une erreur lors de la mise en ligne..' }}
          additionalSections: |
            [              
              {
                "header": "D√©tails de la fusion",
                "collapsible": true,
                "widgets": [
                  { "decoratedText": { "text": "- Titre du commit  : ${{github.event.commits[0].message}}" } },
                  { "decoratedText": { "text": "- Auteur : ${{ github.event.commits[1].author.username }}" } }
                ]
              },
              {
                "header": "R√©sultats des jobs",
                "collapsible": true,
                "widgets": [
                  { "decoratedText": { "text": "- Deployment : ${{ needs.deploy.result }}" } }
                ]
              }
            ]